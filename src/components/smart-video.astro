---
const { data } = Astro.props;

const thumbnailUrl = `https://img.youtube.com/vi/${data.trailerId}/hqdefault.jpg`;
const embedUrl = `https://www.youtube-nocookie.com/embed/${data.trailerId}`;
const videoUrl = `https://www.youtube.com/watch?v=${data.trailerId}`;

let isVideoValid = false;

// 2. The "Pre-flight" Check
if (data.trailerId) {
  try {
    const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${data.trailerId}&format=json`);
    if (response.ok) {
      isVideoValid = true;
    }
  } catch (e) {
    isVideoValid = false;
  }
}
---

{data.trailerId ? (
  <div class="video-container">
    {isVideoValid ? (
      /* VALID VIDEO -> IFRAME */
      <div class="iframe-wrapper">
        <iframe
          src={embedUrl}
          title={`Trailer for ${data.title}`}
          allow="clipboard-write; encrypted-media; gyroscope; web-share"
          referrerpolicy="strict-origin-when-cross-origin"
          allowfullscreen
        ></iframe>
      </div>
    ) : (
      /* INVALID/PRIVATE -> THUMBNAIL CARD */
      <a href={videoUrl} target="_blank" class="video-fallback-card" aria-label="Watch trailer on YouTube">
        <div class="thumbnail-overlay" style={`background-image: url(${thumbnailUrl})`}>
          <div class="play-button">
            <i class="fa-brands fa-youtube"></i>
            <span>Watch on YouTube</span>
          </div>
        </div>
        <div class="fallback-info">
          <p>Trailer: {data.title}</p>
          <small>Playback restricted by YouTube. Click to view on the official site.</small>
        </div>
      </a>
    )}
    </div>
  ) : data.cover && (
    /* No trailerId provided; Display cover */
      <div class="video-container">
        <img src={data.cover} class="iframe-wrapper" />
      </div>
  )}

<style>
  .video-container {
    width: 100%;
    margin: 2rem 0;
  }

  /* IFRAME STYLE */
  .iframe-wrapper {
    position: relative;
    aspect-ratio: 16 / 9;
    border-radius: 12px;
    overflow: hidden;
    background: #000;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    height: 475px;
    margin-left: auto;
    margin-right: auto;
  }
  
  iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  /* FALLBACK CARD STYLE */
  .video-fallback-card {
    display: block;
    text-decoration: none;
    color: inherit;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #eee;
    transition: transform 0.2s, box-shadow 0.2s;
    background: #fdfdfd;
  }

  .video-fallback-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.1);
  }

  .thumbnail-overlay {
    height: 475px;
    background-size: cover;
    background-position: center;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .thumbnail-overlay::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
  }

  .play-button {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    color: white;
  }

  .play-button i {
    font-size: 4rem;
    color: #FF0000; /* YouTube Red */
    filter: drop-shadow(0 4px 10px rgba(0,0,0,0.3));
  }

  .play-button span {
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.9rem;
  }

  .fallback-info {
    padding: 1rem 1.5rem;
  }

  .fallback-info p {
    margin: 0;
    font-weight: bold;
    font-size: 1.1rem;
  }

  .fallback-info small {
    color: #777;
    font-size: 0.85rem;
  }
</style>