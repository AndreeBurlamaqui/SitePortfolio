---
interface Props {
    folder: string; // Expect the slug
}

const { folder } = Astro.props;

// Import images and videos
import fs from 'node:fs';
import path from 'node:path';

const folderPath = path.join(process.cwd(), 'public', 'gallery', folder);

interface MediaItem {
  src: string;
  type: 'video' | 'img';
  title: string;
}

let media: MediaItem[] = [];

if (fs.existsSync(folderPath)) {
  media = fs.readdirSync(folderPath)
    .filter(file => /\.(png|jpe?g|webp|gif|mp4|webm|mov)$/i.test(file))
    .sort()
    .map(file => {
      // Clean the filename
      const nameWithoutExt = path.parse(file).name;
      
      // Replaces hyphens with spaces and Capitalizes First Letter of words (Optional)
      const userFriendlyName = nameWithoutExt
        .split('-')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');

      const isVideo = /\.(mp4|webm|mov)$/i.test(file);

      return {
        src: `/gallery/${folder}/${file}`,
        type: isVideo ? 'video' : 'img',
        title: userFriendlyName
      };
    });
}
---

<aside>
    <div class="gallery-list">
        {media.map((item) => (
            <div 
            class="gallery-item cursor-pointer"
            data-src={item.src}
            data-type={item.type}
            data-title={item.title}
            >
            {item.type === 'video' ? (
                <video muted loop playsinline autoplay src={item.src} />
            ) : (
                <img src={item.src} alt={item.title} loading="lazy" />
            )}

              <div class="zoom-icon"><i class="fa-solid fa-expand"></i></div>

              <div class="tooltip">
                <span>{item.title}</span>
              </div>

            </div>
        ))}
    </div>
  </aside>

<dialog id="lightbox-modal">
  <div class="lightbox-content">

    <div id="lightbox-media-container">
      
      <button id="close-lightbox" class="close-btn">
        <i class="fa-solid fa-square-xmark"></i>
      </button>

    </div>
  </div>
</dialog>

<script>
  // Runs only once per page load
  const dialog = document.getElementById('lightbox-modal') as HTMLDialogElement | null;
  const container = document.getElementById('lightbox-media-container');
  const closeBtn = document.getElementById('close-lightbox');
  const triggers = document.querySelectorAll('.gallery-item');

function openLightbox(src: string, type: string | null, title: string | null) {
        if (!container || !dialog) return;


    // Remove old media/tooltips
    cleanUpLightbox();

    let media;
    if (type === 'video') {
      const vid = document.createElement('video');
      vid.src = src;
      vid.controls = true;
      vid.autoplay = true;
      media = vid;
    } else {
      const img = document.createElement('img');
      img.src = src;
      media = img;
    }
    container.appendChild(media);

    if(title) {
      const tooltipDiv = document.createElement('div');
      tooltipDiv.classList.add("tooltip");
      tooltipDiv.innerHTML = `<span>${title}</span>`;
      container.appendChild(tooltipDiv);
    }
    
    dialog.showModal();
  }

function cleanUpLightbox() {
  if(!container) return;

  const oldMedia = container.querySelectorAll('img, video, .tooltip');
  oldMedia.forEach(el => el.remove());
}

  function closeLightbox() {
    if (!dialog || !container) return;
    dialog.close();
    cleanUpLightbox();
  }

  // Event Listeners
  triggers.forEach(trigger => {
    trigger.addEventListener('click', () => {
      const el = trigger as Element; // Cast 'trigger' to Element to access getAttribute safely
      const src = el.getAttribute('data-src');
      const type = el.getAttribute('data-type');
      const title = el.getAttribute('data-title');
      // Only open if src exists
      if (src) {
        openLightbox(src, type, title);
      }
    });
  });

  if (closeBtn) closeBtn.addEventListener('click', closeLightbox);
  
  if (dialog) {
    dialog.addEventListener('click', (e) => {
      if (e.target === dialog) closeLightbox();
    });
  }
</script>

<style>
  .gallery-list {
    position: sticky;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    overflow-y: auto;
    height: 80vh;
    top: 5rem;

    scroll-snap-type: y mandatory;
}

.gallery-item {
    flex-shrink: 0;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #eee;
    background: #fdfdfd;

    scroll-snap-align: start;
    position: relative;
}

  .gallery-item img, .gallery-item video {
    width: 100%;
    display: block;
    height: auto;
    transition: transform 0.2s;
  }

  .gallery-item:hover img, 
  .gallery-item:hover video {
    transform: scale(1.05); /* Slight zoom in */
}

  /* Zoom Icon Overlay */
  .cursor-pointer { cursor: pointer; }
  
  .zoom-icon {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 10px;
    border-radius: 50%;
    opacity: 0;
    transition: opacity 0.2s;
    pointer-events: none;
  }

  .gallery-item:hover .zoom-icon {
    opacity: 1;
  }

  /* Lightbox Styles */
  dialog {
    border: none;
    background: transparent;
    outline: none;
    padding: 0;
    overflow: hidden;

    /* Fullscreen */
    width: 100vw;
    height: 100vh;
    max-width: 100vw;
    max-height: 100vh;
  }

  dialog::backdrop {
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(4px);
  }

  .lightbox-content {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    width: 100%;
    pointer-events: none;
  }

  #lightbox-media-container {
    justify-items: center;
    align-content: center;
    text-align: center;
    
    display: inline-grid;
    grid-template-columns: 100%;
    grid-template-rows: minmax(0, 1fr) auto;

    max-height: 80vh;
    max-width: 90vw;
    position: relative;
    pointer-events: none;
  }

  .close-btn {
    grid-column: 1;
    grid-row: 1;
    justify-self: end;
    align-self: start;

    background: none;
    border: none;
    color: rgba(0, 0, 0, 0.25);
    font-size: 2rem;
    line-height: 1;
    cursor: pointer;
    z-index: 10;
    pointer-events: all;
    filter: drop-shadow(0 0 2px rgba(0,0,0,0.5));
  }

  .close-btn:hover {
    color: rgb(231, 231, 231);
  }

  .tooltip {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background: linear-gradient(to top, rgba(0,0,0,0.9) 25%, rgba(0,0,0,0) 100%);
    color: white;
    font-size: 0.9rem;
    font-weight: 500;
    text-align: center;
    justify-content: center;
    box-sizing: border-box;
    padding: 40px 10px 10px;
    
    /* Animation settings */
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: 2;
  }

  .gallery-item:hover .tooltip {
    opacity: 1;
    transform: translateY(0);
  }

  #lightbox-media-container :global(.tooltip) {
    opacity: 1;

    background: none;
    color: white;

    font-size: 1.2rem;
    padding: 15px 0px;
    
    position: relative;
    transform: none;
    bottom: auto;
    left: auto;

    grid-column: 1;
    grid-row: 2;

    width: 0; 
    min-width: 100%;
  }

  #lightbox-media-container :global(img), 
  #lightbox-media-container :global(video) {
    grid-column: 1;
    grid-row: 1;

    object-fit: contain;
    display: block;
    width: auto;
    height: auto;
    max-width: 100%;
    max-height: 100%;
    pointer-events: all;

    justify-self: center;
  }
</style>