---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/base-layout.astro';
import '../../styles/global.css';
import ProjectPageHeader from '../../components/project-page-header.astro';
import ProjectGallery from '../../components/project-gallery.astro';

export async function getStaticPaths() {
  const collections = ['released-games', 'ui-studies', 'prototypes'] as const;
  
  const paths = await Promise.all(
    collections.map(async (category) => {
      const items = await getCollection(category);
      return items.map(entry => ({
        params: { category, slug: entry.slug },
        props: { entry },
      }));
    })
  );

  return paths.flat();
}

// General data of the entry
const { entry } = Astro.props;
const { Content } = await entry.render();
---

<BaseLayout title={`${entry.data.title} - AndrÃ©e Burlamaqui`}>
  
  <article class="game-container">
    
    <div class="main-column">

      <ProjectPageHeader project={entry.data} />

      <div class="content-body">
        <Content />
      </div>

    </div>

    <div class="sidebar-container">

      <details class="toc-wrapper">

        <summary>Contents</summary>
        
        <div id="table-of-contents" class="toc" />
      
      </details>
      
      <div class="gallery-wrapper">

        <ProjectGallery folder={entry.slug} />

      </div>

    </div>

  </article>
</BaseLayout>

<script>
  // Automatic summary / table of contents
  document.addEventListener("DOMContentLoaded", () => {
  const tocContainer = document.getElementById("table-of-contents");
  if (tocContainer){
    const headers = document.querySelectorAll(".content-body h1, .content-body h2, .content-body h3") as NodeListOf<HTMLElement>;
    let counters = [0, 0, 0, 0, 0, 0];

    // Create links
    headers.forEach(header => {
      // If header has no ID, create one from the text (e.g., "My Title" -> "my-title")
      if (!header.id) {
        header.id = header.innerText.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '');
      }

      // Counter to add x.y section
      const level = parseInt(header.tagName.substring(1)) - 1;
      counters[level]++;

        // Reset all lower levels (if we hit H2, reset H3, H4...)
        for (let i = level + 1; i < counters.length; i++) {
          counters[i] = 0;
        }

        let numberString = "";
        for (let i = 0; i <= level; i++) {
          numberString += counters[i] + ".";
        }

      // Create the link
      const link = document.createElement("a");
      link.href = `#${header.id}`;
      link.innerText = `${numberString} ${header.innerText}`;
      
      link.classList.add(`toc-${header.tagName.toLowerCase()}`);

      tocContainer.appendChild(link);
    });
  }
});
</script>

<style>
  /* LAYOUT CONTAINER */
  .game-container {
    display: grid;
    grid-template-columns: 3fr 1fr; /* Main Content | Sidebar */
    gap: 6rem;
    width: 90%;
    max-width: 1400px; /* prevents lines from getting too long on 4k screens */
    padding-bottom: 4rem;
    margin-left: auto;
    margin-right: auto;
  }

  /* MARKDOWN CONTENT STYLES */
  .content-body {
    font-size: 0.9rem;
    line-height: 1.7;
    color: #333;
  }
  
  /* Make embedded images in markdown responsive */
  .content-body :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
  }

  .sidebar-container {
  position: sticky;
  top: 5rem;
  
  /* FORCE the sidebar to fit on the screen exactly */
  height: calc(90vh - 6rem); 
  
  /* Organize children vertically */
  display: flex;
  flex-direction: column;
  gap: 1rem;
  
  /* Prevent the sidebar itself from scrolling */
  overflow: hidden; 
}

.toc-wrapper {
  flex-shrink: 0; /* Don't shrink this, show full menu */
  max-height: 40vh; /* If menu is huge, scroll it */
  overflow-y: auto;
}

.toc {
  border: none;
  background: transparent;
  padding: 0 1rem 1rem 1rem;
}

.toc :global(h3) {
  margin-top: 0;
  font-size: 1rem;
  text-transform: uppercase;
  color: #888;
  display: flex;
  flex-direction: column;
}

.toc :global(a) {
  display: block;
  text-decoration: none;
  color: #333;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
  transition: color 0.2s;
}

.toc :global(a:hover) {
  color: #007bff; /* Blue on hover */
}

/* Indent sub-headers automatically */
.toc-h2 { padding-left: 1rem; font-size: 0.85rem; }
.toc-h3 { padding-left: 2rem; font-size: 0.8rem; color: #666; }

.gallery-wrapper {
  flex-grow: 1;  /* Grow to fill all empty space */
  min-height: 0; /* CRITICAL: Allows flex child to scroll internally */
  display: flex; 
  flex-direction: column;
  position: static;
  height: 100%;
  top: auto
}

.gallery-wrapper :global(aside) {
  height: 100%;      /* Force component to fill the wrapper */
  min-height: 0;     /* Allow it to shrink */
  display: flex;     /* Prepare to hold the list */
  flex-direction: column;
}

  /* Responsive Fix for Mobile */
  @media screen and (max-width: 768px) {

    .game-container {
      width: 90%;
      margin-left: 1rem;
      margin-right: auto;
    }

  }
</style>